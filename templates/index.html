<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FURIA Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/themes.css') }}">
</head>
<body class="dark-theme">
    <div class="theme-switcher">
        <button id="theme-toggle">üåô</button>
    </div>
    
    <div class="chat-container">
        <div class="message-box" id="message-box">
            {% for msg in message_history %}
                <div class="message" data-id="{{ msg.id }}">
                    <!-- Conte√∫do da Mensagem -->
                    <div class="message-content">
                        {% if msg.is_bot %}
                            <div class="bot-header">ü§ñ FURIA Bot</div>
                        {% endif %}
                        {{ msg.message|replace("\n", "<br>")|safe }}
                    </div>
    
                    <!-- Bot√µes de A√ß√£o -->
                    <div class="message-actions">
                        <button class="edit-btn" onclick="editMessage('{{ msg.id }}')">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteMessage('{{ msg.id }}')">üóëÔ∏è</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    
        <!-- √Årea de Input (mantida igual) -->
        <div class="input-area">
            <input type="text" id="message-input" placeholder="Digite @FuriaBot para comandos..." autocomplete="off">
            <button id="send-button">Enviar</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const messageBox = document.getElementById('message-box');
    const themeToggle = document.getElementById('theme-toggle');
    let inBotConversation = false;

    // Fun√ß√£o para adicionar mensagem ao chat
    function addMessage(text, isBot = false, id = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isBot ? 'bot-message' : ''}`;
            messageDiv.dataset.id = id || Date.now().toString();
            
            if (isBot) {
                messageDiv.innerHTML = `
                    <div class="bot-header">ü§ñ FURIA Bot</div>
                    <div class="message-content">${text.replace(/\n/g, '<br>')}</div>
                    <div class="message-actions">
                        <button class="delete-btn" onclick="deleteMessage('${messageDiv.dataset.id}')">üóëÔ∏è</button>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${text}</div>
                    <div class="message-actions">
                        <button class="edit-btn" onclick="editMessage('${messageDiv.dataset.id}')">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteMessage('${messageDiv.dataset.id}')">üóëÔ∏è</button>
                    </div>
                `;
            }
            
            messageBox.appendChild(messageDiv);
            messageBox.scrollTop = messageBox.scrollHeight;
            return messageDiv.dataset.id;
        }


    // Fun√ß√£o de envio corrigida
    function sendMessage() {
    let message = messageInput.value.trim();
    
    if (!message) return;

    // For√ßa o padr√£o "@FuriaBot" se detectado
    if (message.toLowerCase() === '@furiabot') {
        message = '@FuriaBot'; // Padroniza o comando
        inBotConversation = true;
        messageInput.value = '@FuriaBot '; // Prepara o input para o pr√≥ximo comando
    }

    // Envia a mensagem mesmo se for s√≥ "@FuriaBot"
    socket.emit('send_message', { message: message });
    
    // Mant√©m o prefixo durante a conversa
    messageInput.value = inBotConversation ? '@FuriaBot ' : '';
    messageInput.focus();
    }

    // Listeners corrigidos
    sendButton.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Socket.io handlers
    socket.on('new_message', (data) => {
        addMessage(data.message);
    });

    socket.on('bot_message', (data) => {
        addMessage(data.message, true);
        inBotConversation = !data.is_final; // Atualiza o estado corretamente
    });

    // Toggle de Tema (Corrigido)
    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.className = `${savedTheme}-theme`;
        themeToggle.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    themeToggle.addEventListener('click', () => {
        const isDark = document.body.classList.contains('dark-theme');
        const newTheme = isDark ? 'light' : 'dark';
        
        document.body.classList.remove(`${isDark ? 'dark' : 'light'}-theme`);
        document.body.classList.add(`${newTheme}-theme`);
        localStorage.setItem('theme', newTheme);
        themeToggle.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    });

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', initializeTheme);
</script>
    <script>
        // Fun√ß√µes para Editar/Apagar
        function editMessage(id) {
            const messageDiv = document.querySelector(`.message[data-id="${id}"]`);
            const contentDiv = messageDiv.querySelector('.message-content:not(.bot-header)');
            
            // Cria input estilizado
            const input = document.createElement('div');
            input.contentEditable = true;
            input.className = 'edit-input';
            input.textContent = contentDiv.textContent;
            
            // Substitui o conte√∫do
            contentDiv.replaceWith(input);
            input.focus();
            
            // Fun√ß√£o para salvar
            const saveEdit = () => {
                const newText = input.textContent.trim();
                if (newText) {
                    socket.emit('edit_message', { 
                        id, 
                        message: newText 
                    });
                }
                // Restaura o elemento original
                const newContent = document.createElement('div');
                newContent.className = 'message-content';
                newContent.innerHTML = newText.replace(/\n/g, '<br>');
                input.replaceWith(newContent);
            };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveEdit();
                }
            });
        }

        // Deletar mensagem
        function deleteMessage(id) {
            if (confirm('Tem certeza que deseja apagar esta mensagem?')) {
                socket.emit('delete_message', { id });
                document.querySelector(`.message[data-id="${id}"]`).remove();
            }
        }

        // Atualizar mensagem editada
        socket.on('message_edited', (data) => {
            const messageDiv = document.querySelector(`.message[data-id="${data.id}"]`);
            if (messageDiv) {
                messageDiv.querySelector('.message-content').textContent = data.message;
            }
        });
        
        socket.on('message_deleted', function(id) {
            const messageDiv = document.querySelector(`.message[data-id="${id}"]`);
            if (messageDiv) {
                messageDiv.remove();
            }
        });
    </script>
</body>
</html>